<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Automated Canary Builds</title>
  <meta name="description" content="Like many iOS projects, yours probably also has external code dependencies. There’s a number of options how to manage them. You can do it manually by including other projects into your workspace or..." />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@JanGorman" />
    <meta name="twitter:title" content="Automated Canary Builds" />
    <meta name="twitter:image" content="" />
    
    <meta name="twitter:description"  content="Like many iOS projects, yours probably also has external code dependencies. There’s a number of options how to manage them. You can do it manually by including other projects into your workspace or..." />
    
  
  
  <meta property="og:site_name" content="Jan Gorman" />
  <meta property="og:title" content="Automated Canary Builds"/>
  
  <meta property="og:description" content="Like many iOS projects, yours probably also has external code dependencies. There’s a number of options how to manage them. You can do it manually by including other projects into your workspace or..." />
  
  <meta property="og:image" content="" />
  <meta property="og:url" content="/blog/2015/03/15/automated-canary-builds/" >
  <meta property="og:type" content="blog" />
  <meta property="article:published_time" content="2015-03-15T10:59:18+01:00">

  <link rel="canonical" href="/blog/2015/03/15/automated-canary-builds/"/>
  <link rel="shortcut icon" href="/assets/images/favicon.png" type="image/png"/>
  <link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/css/print.css" />
</head>
  <link href='/stylesheets/all-456658fd402f091f6213dc405e964de6.css' media='all' rel='stylesheet' type='text/css'>
  <body itemscope itemtype="http://schema.org/Article">
    <!-- header start -->


<!-- header end -->
    <main class="content" role="main">
      <article class="post">
        
        <div class="noarticleimage">
          <div class="post-meta">
            <h1 class="post-title">Automated Canary Builds</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/assets/images/jg.jpg)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person"></h4>
              on
              <time datetime="2015-03-15T10:59:18+01:00">15 Mar 2015</time>
            </div>
          </div>
        </div>
        <br>
        <br>
        <br>
        
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <p>Like many iOS projects, yours probably also has external code dependencies. There’s a number of options how to manage them. You can do it manually by including other projects into your workspace or automate the whole process with tools such as <a href="http://cocoapods.org">Cocoapods</a>, the newer <a href="https://github.com/Carthage/Carthage">Carthage</a> or the little known <a href="https://github.com/buildinspace/peru">peru</a>, which functionally sits somewhere between manually managing dependencies and Carthage.</p>

<p>Whichever way you go, you should always integrate against known versions of these libraries to ensure that builds are reproducible. You’ll probably want to stay up to date with newer releases to receive security and bug fixes or performance improvements but at the same time not spend too much effort on manually updating them and verifying that there aren’t any bugs. This is were a nightly <strong>Canary Build</strong> comes into play that automatically checks for any updated libraries, creates a build, and runs your tests. A successful build indicates that it’s safe for you to update.</p>

<p>I’ll focus on Cocoapods here, since that’s the one we use at work and also has a nice option to check for new versions of pods. In its simplest form a <code class="highlighter-rouge">Podfile</code> looks like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">source</span> <span class="s1">'https://github.com/CocoaPods/Specs'</span>
<span class="n">pod</span> <span class="s1">'AFNetworking'</span>
</code></pre></div></div>

<p>No version information whatsoever. But running <code class="highlighter-rouge">pod install</code> will also generate a <code class="highlighter-rouge">Podfile.lock</code> (which you should <em>always</em> check in to your repository). In the past I’ve shied away from doing this or the loosely versioned way of defining a dependency with e.g. <code class="highlighter-rouge">pod 'AFNetworking', '~&gt; 2'</code> because I wanted to be able to see which version of a library is included at a glance.</p>

<p>So in my case, the <code class="highlighter-rouge">Podfile</code> might look something like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">source</span> <span class="s1">'https://github.com/CocoaPods/Specs'</span>

<span class="n">platform</span> <span class="ss">:ios</span><span class="p">,</span> <span class="s1">'7.0'</span>
<span class="n">xcodeproj</span> <span class="s1">'AwesomeProject'</span>

<span class="n">pod</span> <span class="s1">'1PasswordExtension'</span><span class="p">,</span> <span class="s1">'1.1.1'</span>
<span class="n">pod</span> <span class="s1">'AFNetworking'</span><span class="p">,</span> <span class="s1">'2.5.0'</span>
<span class="n">pod</span> <span class="s1">'AFNetworkActivityLogger'</span><span class="p">,</span> <span class="s1">'2.0.3'</span>
<span class="n">pod</span> <span class="s1">'CocoaLumberjack'</span><span class="p">,</span> <span class="s1">'1.9.1'</span>
<span class="n">pod</span> <span class="s1">'DBCamera'</span><span class="p">,</span> <span class="s1">'2.3.6'</span>
<span class="n">pod</span> <span class="s1">'TTTAttributedLabel'</span><span class="p">,</span> <span class="s1">'1.10.2'</span>
<span class="err">…</span>
</code></pre></div></div>

<p>Cocoapods comes with the very handy <code class="highlighter-rouge">outdated</code> command to find out about any new versions:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>pod outdated

Updating spec repositories
Analyzing dependencies
The following updates are available:
- 1PasswordExtension 1.1.1 -&gt; 1.1.2 <span class="o">(</span>latest version 1.1.2<span class="o">)</span>
- AFNetworkActivityLogger 2.0.3 -&gt; 2.0.3 <span class="o">(</span>latest version 2.0.4<span class="o">)</span>
- AFNetworking 2.5.0 -&gt; 2.5.0 <span class="o">(</span>latest version 2.5.1<span class="o">)</span>
- CocoaLumberjack 1.9.1 -&gt; 1.9.1 <span class="o">(</span>latest version 2.0.0<span class="o">)</span>
- DBCamera 2.3.6 -&gt; 2.3.6 <span class="o">(</span>latest version 2.3.13<span class="o">)</span>
- TTTAttributedLabel 1.10.2 -&gt; 1.10.2 <span class="o">(</span>latest version 1.13.2<span class="o">)</span>
</code></pre></div></div>

<p>And then I’d usually go in by hand, update the <code class="highlighter-rouge">Podfile</code>, run <code class="highlighter-rouge">install</code> and build the project. Obviously not the best use of anyone’s time. So this is where the Canary Build comes into play. As part of a <a href="http://jenkins-ci.org">Jenkins</a> build script (I like ruby) you could do something like the following to automatically update a strictly versioned <code class="highlighter-rouge">Podfile</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">update_pods</span>
  <span class="n">updates</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">[</span><span class="sx">%x{pod outdated}</span>
    <span class="p">.</span><span class="nf">lines</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="n">line</span><span class="p">.</span><span class="nf">start_with?</span><span class="p">(</span><span class="s1">'-'</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">.</span><span class="nf">collect</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> 
      <span class="n">match</span> <span class="o">=</span> <span class="sr">/(?&lt;pod&gt;[[:alnum:]]{1,}).{1,}(?:[latest version])(?&lt;version&gt;[0-9.]{1,})/</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
      <span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="s1">'pod'</span><span class="p">],</span> <span class="n">match</span><span class="p">[</span><span class="s1">'version'</span><span class="p">]]</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span> <span class="p">}</span>
  <span class="p">]</span>

  <span class="k">return</span> <span class="k">if</span> <span class="n">updates</span><span class="p">.</span><span class="nf">empty?</span>

  <span class="n">lines</span> <span class="o">=</span> <span class="no">IO</span><span class="p">.</span><span class="nf">readlines</span><span class="p">(</span><span class="s1">'Podfile'</span><span class="p">).</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">start_with?</span><span class="p">(</span><span class="s1">'pod'</span><span class="p">)</span>
      <span class="n">match</span> <span class="o">=</span> <span class="sr">/pod\s['|"](?&lt;pod&gt;[[:alnum:]]{1,})["|']/</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">match</span><span class="p">.</span><span class="nf">nil?</span> <span class="o">&amp;&amp;</span> <span class="n">updates</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="s1">'pod'</span><span class="p">]]</span>
        <span class="n">pod</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="s1">'pod'</span><span class="p">]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">"pod '</span><span class="si">#{</span><span class="n">pod</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">updates</span><span class="p">[</span><span class="n">pod</span><span class="p">]</span><span class="si">}</span><span class="s2">'"</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">line</span>
  <span class="k">end</span>

  <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s1">'Podfile'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
    <span class="n">file</span><span class="p">.</span><span class="nf">puts</span> <span class="n">lines</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>A little bit of regex magic to extract the pod name and new version into a hash which we can match against the <code class="highlighter-rouge">Podfile</code> and update if needed. Then the script would go off and run <code class="highlighter-rouge">pod update</code>, build and run tests and maybe even upload to HockeyApp or TestFlight and send out an email with which pods it updated.</p>

<p>But of course once you start automating this, there is no need to actually version the pods anymore since you’ll have the generated <code class="highlighter-rouge">Podfile.lock</code> and/or let the script inform you about any pods it did update. In such a case it’s enough to simply:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">update_pods</span>
  <span class="n">updates</span> <span class="o">=</span> <span class="sx">%x{pod outdated}</span>
    <span class="p">.</span><span class="nf">lines</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="n">line</span><span class="p">.</span><span class="nf">start_with?</span><span class="p">(</span><span class="s1">'-'</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">return</span> <span class="k">if</span> <span class="n">updates</span><span class="p">.</span><span class="nf">empty?</span>
  <span class="sx">%x{pod update}</span>
  <span class="sx">%x{xctool test}</span>
  <span class="c1"># Send out list of updated pods via email</span>
<span class="k">end</span>
</code></pre></div></div>

<p>A similar approach should also be possible using Carthage if you’re willing to go without fixed versions since it will generate a <code class="highlighter-rouge">Cartfile.resolved</code> with a fixed version used for the build.</p>

<h3 id="wrap-up">Wrap-up</h3>

<p>We have several Jenkins jobs running already for different branches and pre-release versions. Adding a nightly Canary Build is a logical next step and I’d urge anyone to give it a try. The effort to set it up is fairly low but it does free up a lot of time in the long run and should also help with the overall stability of your apps. I’d love to hear about your ideas or experiences with such a process. <a href="https://twitter.com/JanGorman">Get in touch on Twitter.</a></p>

        </section>
        <footer class="post-footer">
          <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=Automated+Canary+Builds&amp;url=/blog/2015/03/15/automated-canary-builds"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
            
          </section>
        </footer>
        <div class="bottom-teaser cf">
          <div class="isLeft">
            <h5 class="index-headline featured"><span>Written by</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(/assets/images/jg.jpg)">Blog Logo</div>
              <h4>Jan Gorman</h4>
              <p class="bio"></p>
              <hr>
              <p class="published">Published <time datetime="2015-03-15 10:59">15 Mar 2015</time></p>
            </section>
          </div>
          
          <div class="isRight">
            <h5 class="index-headline featured"><span>Supported by</span></h5>
            <footer class="site-footer">
              <section class="poweredby">Proudly published with <a href="http://jekyllrb.com"> Jekyll</a></section>
              <a class="subscribe" href="/feed.xml"> <span class="tooltip"> <i class="fa fa-rss"></i> You should subscribe to my feed.</span></a>
              <div class="inner">
                <section class="copyright">All content copyright <a href="/">Jan Gorman</a> &copy; 2017<br>All rights reserved.</section>
              </div>
            </footer>
          </div>
        </div>
        
      </article>
    </main>
    <div class="bottom-closer">
      <div class="background-closer-image"  style="background-image: url(/assets/images/background-image.jpg)">
        Image
      </div>
      <div class="inner">
        <h1 class="blog-title">Jan Gorman</h1>
        <h2 class="blog-description">Compiling Swift Source Files</h2>
        <a href=/ class="btn">Back to Overview</a>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/assets/js/index.js"></script>
<script type="text/javascript" src="/assets/js/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    
      $window.on('scroll', function() {
        var top = $window.scrollTop();

        if (top < 0 || top > 1500) { return; }
        $image
          .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
          .css('opacity', 1-Math.max(top/700, 0));
      });
      $window.trigger('scroll');

      var height = $('.article-image').height();
      $('.post-content').css('padding-top', height + 'px');

      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
         && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({ scrollTop: target.offset().top }, 500);
            return false;
          }
        }
      });

  });
}(jQuery));
</script>
  </body>
</html>
