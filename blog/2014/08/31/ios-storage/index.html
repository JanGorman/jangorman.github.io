<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>iOS Storage</title>
  <meta name="description" content="When it comes to persistence for iOS there are a few options to choose from:" />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@JanGorman" />
    <meta name="twitter:title" content="iOS Storage" />
    <meta name="twitter:image" content="" />
    
    <meta name="twitter:description"  content="When it comes to persistence for iOS there are a few options to choose from:" />
    
  
  
  <meta property="og:site_name" content="Jan Gorman" />
  <meta property="og:title" content="iOS Storage"/>
  
  <meta property="og:description" content="When it comes to persistence for iOS there are a few options to choose from:" />
  
  <meta property="og:image" content="" />
  <meta property="og:url" content="/blog/2014/08/31/ios-storage/" >
  <meta property="og:type" content="blog" />
  <meta property="article:published_time" content="2014-08-31T11:57:36+02:00">

  <link rel="canonical" href="/blog/2014/08/31/ios-storage/"/>
  <link rel="shortcut icon" href="/assets/images/favicon.png" type="image/png"/>
  <link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/css/print.css" />
</head>
  <link href='/stylesheets/all-456658fd402f091f6213dc405e964de6.css' media='all' rel='stylesheet' type='text/css'>
  <body itemscope itemtype="http://schema.org/Article">
    <!-- header start -->


<!-- header end -->
    <main class="content" role="main">
      <article class="post">
        
        <div class="noarticleimage">
          <div class="post-meta">
            <h1 class="post-title">iOS Storage</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/assets/images/jg.jpg)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person"></h4>
              on
              <time datetime="2014-08-31T11:57:36+02:00">31 Aug 2014</time>
            </div>
          </div>
        </div>
        <br>
        <br>
        <br>
        
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <p>When it comes to persistence for iOS there are a few options to choose from:</p>

<ul>
  <li><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/CoreData/cdProgrammingGuide.html">Core Data</a></li>
  <li><a href="http://www.sqlite.org">SQLite</a></li>
  <li><a href="https://developer.apple.com/library/mac/documentation/cocoa/reference/Foundation/Classes/NSKeyedArchiver_Class/Reference/Reference.html">NSKeyedArchiver</a></li>
  <li><a href="https://github.com/nicklockwood/FastCoding">FastCoding</a></li>
  <li><a href="https://github.com/yaptv/YapDatabase">YapDatabase</a></li>
  <li><a href="http://realm.io">Realm</a></li>
</ul>

<p>Which one you end up using of course depends on your use case and each of the solutions has some tradeoff with regards to read/write performance and implementation complexity.</p>

<h3 id="background">Background</h3>

<p>At work we had been using Core Data with <a href="https://github.com/magicalpanda/MagicalRecord">Magical Record</a> shielding us from some of the gory implementation details when it comes to wrangling with different <code class="highlighter-rouge">NSManagedObjectContext</code> and getting out of the users main thread.</p>

<p>Another promise of MagicalRecord are “free” lightweight core data migrations using <code class="highlighter-rouge">[MagicalRecord setupCoreDataStackWithAutoMigratingSqliteStoreNamed:@"storage.sqlite"]</code> and so one fateful release we decided to kill off an old, unused model. Prior tests revealed no issues going ahead with the migration but a certain combination of being logged in to the app and adding something to your shopping cart resulted in the dreaded <code class="highlighter-rouge">Can't merge models with two different entities named …</code> error. A revert and a fast-track approval by Apple saved the day but confidence in MR and Core Data was… a bit shaken.</p>

<h3 id="enter-yap">Enter Yap</h3>

<p>I had privately been playing around with <a href="https://github.com/yaptv/YapDatabase">YapDatabase</a> and liked it. A lot. Concurrency, views, it being a key-value storage built on top of SQLite and especially the concept of <code class="highlighter-rouge">YapDatabaseViewRowChange</code> for updating table views made for compelling features.</p>

<p>So I pitched the idea at work and we migrated over some Core Data tables to Yap. One thing that became obvious during the development was that Yap requires quite a bit of boilerplate code to set up. You always end up creating views, long lived transactions and managing <code class="highlighter-rouge">NSNotification</code> to update said transactions. But I rationalized it as being a one time effort and chugged along.</p>

<p>After the release our Crashlytics popped up with an unnerving number of Yap related crashes. Not all, but most having to do with notifications being sent to deallocated observers. This seemed rather strange as we were removing the observer correctly on deallocation and never found a root cause. Stability of the app got so bad though that a hotfix release was scheduled and Yap was replaced.</p>

<h3 id="enter-nskeyedarchiver">Enter NSKeyedArchiver</h3>

<p>We went back to the drawing board and considered our options. We didn’t want to deal with Core Data’s complexity any longer and reliance on complex third party libraries had left a sour taste. What do we know:</p>

<ul>
  <li>Storage has to run in the background and not block the main thread</li>
  <li>We don’t have any big tables… the biggest one needs to store 100 entries. (Others are out of our control because customer’s fill them so a huge buffer would set an upper limit of 500 entries)</li>
  <li>It needs to be simple, every one on the team should immediately know what’s going on</li>
  <li>No third party library if possible</li>
  <li>No need to store anything in iCloud, any syncing happens between the app and our own servers</li>
</ul>

<p><code class="highlighter-rouge">NSKeyedArchiver</code> gets a bad wrap for being slow, and yes, try to store a lot of values (in the thousands!) and it degrades pretty badly but for the use case stated above of maybe 500 entries it actually is pretty decent. Xcode 6 adds the handy <code class="highlighter-rouge">[self measureBlock:^{}]</code>, time for some benchmarks.</p>

<ul>
  <li>Yap scored a write performance of 0.005 seconds. Great result</li>
  <li>FastCoding came in a respectable second with 0.013 seconds</li>
  <li>NSKeyedArchiver scored last with 0.110 seconds</li>
</ul>

<p>But, and this is a huge but, it is fast enough for our needs. The database (or essentially just an <code class="highlighter-rouge">NSArray</code>) is read on into memory and any changes to the data also happen in memory and it actually is very snappy to use. Persisting to disk is done on a background thread using an <code class="highlighter-rouge">NSOperationQueue</code> with a size of one so all additions and deletes queue up nicely and there are no nasty concurrency issues to deal with.</p>

<p>A neat side effect was that we also don’t need separate models for Core Data and our API anymore. We use <a href="https://github.com/Mantle/Mantle">Mantle</a> extensively and the cool thing is that all <code class="highlighter-rouge">MTLModel</code> subclasses also comply to <code class="highlighter-rouge">&lt;NSCoding&gt;</code>. We can pass the same values back and forth.</p>

<h3 id="learning">Learning</h3>

<ul>
  <li>Always know your real use case</li>
  <li>Benchmark!</li>
  <li>Don’t rely on third party libraries as much. Cocoapods are <em>awesome</em> but sometimes simple does it.</li>
  <li>Find edge cases during your QA phase</li>
</ul>

        </section>
        <footer class="post-footer">
          <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=iOS+Storage&amp;url=/blog/2014/08/31/ios-storage"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
            
          </section>
        </footer>
        <div class="bottom-teaser cf">
          <div class="isLeft">
            <h5 class="index-headline featured"><span>Written by</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(/assets/images/jg.jpg)">Blog Logo</div>
              <h4>Jan Gorman</h4>
              <p class="bio"></p>
              <hr>
              <p class="published">Published <time datetime="2014-08-31 11:57">31 Aug 2014</time></p>
            </section>
          </div>
          
          <div class="isRight">
            <h5 class="index-headline featured"><span>Supported by</span></h5>
            <footer class="site-footer">
              <section class="poweredby">Proudly published with <a href="http://jekyllrb.com"> Jekyll</a></section>
              <a class="subscribe" href="/feed.xml"> <span class="tooltip"> <i class="fa fa-rss"></i> You should subscribe to my feed.</span></a>
              <div class="inner">
                <section class="copyright">All content copyright <a href="/">Jan Gorman</a> &copy; 2017<br>All rights reserved.</section>
              </div>
            </footer>
          </div>
        </div>
        
      </article>
    </main>
    <div class="bottom-closer">
      <div class="background-closer-image"  style="background-image: url(/assets/images/background-image.jpg)">
        Image
      </div>
      <div class="inner">
        <h1 class="blog-title">Jan Gorman</h1>
        <h2 class="blog-description">Compiling Swift Source Files</h2>
        <a href=/ class="btn">Back to Overview</a>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/assets/js/index.js"></script>
<script type="text/javascript" src="/assets/js/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    
      $window.on('scroll', function() {
        var top = $window.scrollTop();

        if (top < 0 || top > 1500) { return; }
        $image
          .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
          .css('opacity', 1-Math.max(top/700, 0));
      });
      $window.trigger('scroll');

      var height = $('.article-image').height();
      $('.post-content').css('padding-top', height + 'px');

      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
         && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({ scrollTop: target.offset().top }, 500);
            return false;
          }
        }
      });

  });
}(jQuery));
</script>
  </body>
</html>
